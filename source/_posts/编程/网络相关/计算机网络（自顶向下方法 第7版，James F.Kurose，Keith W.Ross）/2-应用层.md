---
title: 应用层
categories: 编程
tags:
  - 网络
date: 2023-05-04 17:35:01
---

来自[中科大郑烇、杨坚全套《计算机网络（自顶向下方法 第7版，James F.Kurose，Keith W.Ross）》课程](https://www.bilibili.com/video/BV1JV411t7ow/?spm_id_from=333.337.search-card.all.click&vd_source=22653c02dfbe0c9c7bb4a200eb87fe4e)


<a href="#overview">2.0 应用层概述</a>
<a href="#protocol">2.1 应用层协议原理</a>
<a href="#web">2.2 Web and HTTP</a>
<a href="#ftp">2.3 FTP*</a>
<a href="#email">2.4 Email，SMTP，POP3，IMAP</a>
<a href="#dns">2.5 DNS</a>
<a href="#p2p">2.6 P2P应用</a>
<a href="#cdn">2.7 CDN</a>
<a href="#tcp">2.8 TCP套接字（Socket）编程</a>
<a href="#udp">2.9 UDP套接字编程</a>

<h1 id="overview">2.0 应用层概述</h1>
{% asset_img 20230504-115306.jpeg 概述 %}


<h1 id="protocol">2.1 应用层协议原理</h1>

{% asset_img 20230504-115954.jpeg 网络应用的例子 %}

### 网络应用的体系结构
- 客户-服务器模式（C/S client/service）
  - 服务器
    - 一直运行
    - 固定的IP地址和周知的端口号
    - 扩展性差，数据中心进行扩展
  - 客户端
    - 主动与服务器通信
    - 与互联网有间歇性的连接
    - 可能是动态IP地址
    - 不直接与其他客户端通信
- 对等模式（P2P Peer To Peer）
  - （几乎）没有一直运行的服务器
  - 任意端系统之间可以进行通信
  - 每个节点即是客户端又是服务器
    - 自扩展性-新peer节点带来新的服务能力，当然也带来新的服务请求
  - 参与的主机间歇性连接且可以改变IP地址（难以管理）
  - 例子：Gnutella，迅雷
- 混合体：客户服务器和对等体系结构
  - Napster
    - 文件搜索：集中
      - 主机在中心服务器上注册其资源
      - 主机在中心服务器查询资源位置
    - 文件传输： P2P
      - 任意Peer节点之间
  - 即时通信
    - 在线检测：集中
      - 当用户上线时，向中心服务器注册其IP地址
      - 用户与中心服务器联系，以找到其在线好友的位置
    - 两个用户之间聊天 P2P

### 进程通信
进程：在主机上运行的应用程序
- 在同一个主机内，使用进程间通信机制通信（操作系统定义）
- 不同主机，通过交换报文（Message）来通信
  - 使用OS提供的通信服务
  - 按应用协议交换报文（借助传输层提供的服务）

**clients servers**
- 客户端进程：发起通信的进程
- 服务器进程：等待连接的进程

> P2P架构的应用也有客户端进程和服务器进程之分

### 分布式进程通信需要解决的问题
1. 进程表示和寻址问题（服务用户）
2. 传输层-应用层提供服务时如何（服务）
   1. 位置：层间界面的SAP（TCP/IP socket）
   2. 形式：应用程序接口API（TCP/IP socket api）
3. 如何使用传输层提供的服务，实现应用进程之间的报文交换，实现应用（用户使用服务）
   1. 定义应用层协议：报文格式，解释，时序等
   2. 编制程序，使用OS提供的API，调用网络基础设施提供通信服务传报文，实现应用时序等；

### 对进程进行编址（addressing）
-  进程为了接受报文，必须有一个标识即：SAP（发送也需要标示）
   -  主机：为一个32位IP地址
      -  仅仅有IP地址不能唯一标识一个进程，在一台端系统上有很多应用进程在运行
   - 所采用的传输层协议：TCP or UDP
   - 端口号（Port Numbers）
- 一些知名端口号的例子
  - HTTP TCP 80
  - Mail TCP 25
  - ftp TCP 21
- 一个进程： 用IP+port标示端节点
- 本质上，一对主机进程之间的通信由两个端节点构成

### 传输层提供的服务-层间信息的代码
- 如果socket api每次传输报文，都携带如此多的信息，太繁琐易错，不便于管理
- 用个代号标示通信的双方或者单方：socket
- 就像OS打开文件返回的句柄意义
  - 对句柄的操作，就是对文件的操作
- TCP socket
  - TCP服务，对两个进程之间的通信需要之前要建立连接
    - 两个进程通信会持续一段时间，通信关系稳定
  - 可以用一个证书表示两个应用实体之间的通信关系，本地标识
  - 穿过层间接口的信息量最小
  - TCP socket：源IP，源端口，目标IP，目标端口
- UDP socket
  - UDP服务，两个进程之间的通信需要之前无需建立连接
    - 每个报文都是独立传输的
    - 前后报文可能给不同的分布式进程
  - 因此只能用一个整数表示本应用实体的标示
    - 因为这个报文可能传给另外一个分布式进程
  - 穿过层间接口的信息大小最小
  - UDP socket 2元组（本IP 本端口）
  - 但是传输报文时，必须要提高对方IP，port
    - 接受报文时，传输层需要上传对方的IP，port

### TCP之上的套接字（Socket）
对于使用面向连接服务（TCP）的应用而言，套接字是4元组的一个具有本地意义的标示
- 4元组（源IP，源port，目标IP，目标port）
- 唯一指定了一个会话（两个进程之间的会话关系）
- 应用使用这个标识，与远程的应用程序通信
- 不必在每个报文的发送都要指定这4元组
- 就像使用操作系统打开一个文件，OS返回一个文件句柄一样，以后使用这个文件句柄，而不是使用这个文件的目录名、文件名
- 简单，便于管理

### UDP之上的套接字（Socket）
对于使用无连接服务（UDP）的应用而言，套接字是2元组的一个具有本地意义的标示
  2元组（源IP，源port）
- UDP套接字指定了应用所在的一个端节点（end point）
- 在发送数据报时，采用创建好的本地套接字（标识ID），就不必在发送每个报文中指明白自己所采用的ip和port
- 但是在发送报文时必须要指定对方的ip和UDP port

### 安全TCP
- TCP & UDP
  - 都没有加密
  - 明文通过互联网传输，甚至密码
- SSL
  - 在TCP上面实现，提供加密的TCP连接
  - 私密性
  - 数据完整性
  - 端到端的鉴别
- SSL在应用层
  - 应用采用SSL库，SSL库使用TCP通信
- SSL socket API
  - 应用通过API将明文交给socket，SSL将其加密在互联网上传输



<h1 id="web">2.2 Web and HTTP</h1>
这部分内容比较基础不再做过多的记录

往返时间 RTT（round-trip-time）：一个小的分组从客户端到服务器，再回到客户端的时间（传输时间忽略）

**获取一个文件对象需要两个RTT**
- 一个RTT发起TCP连接
- 一个RTT用来HTTP请求并等待HTTP响应


{% asset_img 20230505-225702.jpeg 网路流量例子 %}

流量强度根据计算公式 = (分组大小*分组速率)/带宽 
LAN的流量强度= (0.1*15)/1000 = 0.15%
接入链路的流量强度= (0.1*15)/1.544 = 0.9715 (强度接近1，其他延时可以忽略不记)
总延时=LAN延时+接入延时+Internet延时 = ms + min + 2s(根据假设)

最后这个网路的总延时是分钟级的，甚至更长

为了解决这个问题解决方案如下
- 增加接入链路的带宽
  根本原因是接入链路流量强度接近1耗时严重，比如把接入链路的带宽从1.54Mbps升级到154Mbps
  接入链路的流量强度= (0.1*15)/154 = 0.0097 
  接入链路耗时 = I/(1-I)*L/R = 0.0097/(1-0.0097)*(1.5/154) = 0.0000954s 很小的时间可以忽略不计
  最后总的耗时接近2s
- 内网增加缓存
  比如现在40%的请求都可以走缓存，60%请求外网
  总的时间计算方式 = 0.4*t1 + 0.6*t2
  t1的时间是ms级可以忽略不计
  t2 = LAN延时+接入延时+Internet延时，现在只有接入延时需要重新计算
  增加缓存之后接入链路的流量强度 = 0.1Mb * 15 * 0.6 / 1.54Mbps = 0.58
  t2接入延时 = I/(1-I)*L/R = 0.58/(1-0.58)*(1.5*0.6/1.54) = 0.8s 实际算出来的时间是秒级的和视频讲的不一致，但是不影响结论
  0.6 * (ms + 0.8s + 2s) = 1.68s 比增加带宽的效果更好
  成本：缓存服务器（比较廉价）


<h1 id="ftp">2.3 FTP*</h1>

### FTP 文件传输协议
- 向远程主机传输文件或从远程主机上接受文件
- 客户/服务器模式
  - 客户端：发起传输的一方
  - 服务器：远程主机
- ftp：RFC959
- ftp服务器端口 21

### 控制链接和数据连接分开

- FTP客户端与FTP服务器通过端口21联系，并使用TCP为传输协议
- 客户端通过控制链接或得身份确认
- 客户端通过控制连接发送命令浏览远程目录
- 收到一个文件传输命令时，服务器打开一个到客户端的数据连接
- 一个文件传输完成后，服务器关闭连接
- 服务器打开第二个TCP数据连接勇来传输另外一个文件
- 控制连接：带外（out of band）传送
- FTP服务器维护用户的状态信息
- FTP服务器维护用户的状态信息：当前路径、用户账户与控制连接对应

{% asset_img 20230506-090955.jpeg FTP命令、响应 %}

<h1 id="email">2.4 Email，SMTP，POP3，IMAP</h1>

### 电子邮件 EMail
- 3个主要组成部分
  - 用户代理
    - 又名“邮件阅读器”
    - 撰写、编辑和阅读邮件
    - 如Outlook、Foxmail
    - 输出和输入邮件保存在服务器上
  - 邮件服务器
    - 邮箱中管理和维护发送给用户的邮件
    - 输出报文队列保持待发送邮件报文
    - 邮件服务器之间的SMTP协议：发送email报文
      - 客户：发送方邮件服务器
      - 服务器：接收端邮件服务器
  - 简单邮件传输协议：SMTP 【RFC 2821】
    - 使用TCP在客户端和服务器之间传送报文，端口号为25
    - 直接传输：从发送方服务器到接收方服务器
    - 传输的3个阶段
      - 握手
      - 传输报文
      - 关闭
    - 命令/响应交互
      - 命令：ASCII文本
      - 响应：状态码和状态信息
    - 报文必须为7位ASCII码

### 例子：Alice给Bob发送报文

1. Alice使用用户代理撰写邮件并发送给Bob
2. Alice的用户代理将邮件发送到她的邮件服务器：邮件放在报文队列中
3. SMTP的客户端打开到Bob邮件服务器的TCP连接
4. SMTP客户端通过TCP连接发送Alice的邮件
5. Bob的邮件服务器将邮件放到Bob的邮箱
6. Bob调用他的用户代理阅读邮件

### 报文格式：多媒体扩展
MIME：多媒体邮件扩展（Multimedia mail extension），RFC 2045，0256
在报文首部用额外的行申明MIME内容类型
{% asset_img 20230506-232702.jpeg MIME内容 %}

### 邮件访问协议
{% asset_img 20230506-232940.jpeg 邮件访问协议 %}

### POP3与IMAP

POP3【本地管理文件夹】
用户确认阶段

- 客户端命令： 
  -  user: 申明用户名 
  -  pass: 口令
- 服务器响应 
  -  +OK 
  -  -ERR
事物处理阶段, 客户端：
- list: 报文号列表
- retr: 根据报文号检索报文
- dele: 删除

- 先前的例子使用 “下载并删除”模式。 
  - 如果改变客户机，Bob不能阅读邮件
- “下载并保留”：不同客户机上为报文的拷贝
- POP3在会话中是无状态的

IMAP 【远程管理文件夹】
- IMAP服务器将每个报文与一个文件夹联系起来
- 允许用户用目录来组织报文
- 允许用户读取报文组件
- IMAP在会话过程中保留用户状态： 
  - 目录名、报文ID与目录名之间映射



<h1 id="dns">2.5 DNS</h1>
<h1 id="p2p">2.6 P2P应用</h1>
<h1 id="cdn">2.7 CDN</h1>
<h1 id="tcp">2.8 TCP套接字（Socket）编程</h1>
<h1 id="udp">2.9 UDP套接字编程</h1>
