---
title: 传输层
categories: 编程
tags:
  - 网络
date: 2023-05-04 17:35:01
---

来自[中科大郑烇、杨坚全套《计算机网络（自顶向下方法 第7版，James F.Kurose，Keith W.Ross）》课程](https://www.bilibili.com/video/BV1JV411t7ow/?spm_id_from=333.337.search-card.all.click&vd_source=22653c02dfbe0c9c7bb4a200eb87fe4e)


<a href="#overview">3.0 传输层概述</a>
<a href="#protocol">3.1 多路复用解复用</a>
<a href="#web">2.2 Web and HTTP</a>
<a href="#ftp">2.3 FTP*</a>
<a href="#email">2.4 Email，SMTP，POP3，IMAP</a>
<a href="#dns">2.5 DNS</a>
<a href="#p2p">2.6 P2P应用</a>
<a href="#cdn">2.7 CDN</a>
<a href="#tcp">2.8 TCP套接字（Socket）编程</a>
<a href="#udp">2.9 UDP套接字编程</a>
<a href="#summary">2.10 小结</a>

<h1 id="overview">3.0 传输层概述</h1>
- 理解传输层的工作原理
  - 多路复用/解复用
  - 可靠数据传输
  - 流量控制
  - 拥塞控制
- 学习internet的传输层协议
  - TCP
    - TCP的拥塞控制
  - UDP
  
<h1 id="protocol">3.1 多路复用解复用</h1>

TCP的复用和解复用

TCP的socket其实是以下四元组的一个数字标识和唯一一个PID对应
在连接建立之后在服务器和客户端都会在内存中建立一个唯一的socket连接
发送方发送数据时【源IP，源端口】=>【目标IP，目标端口】会复用该socket进行发送
接收方收到数据时解析数据包中的IP和端口信息，找到唯一的socket，把报文交给socket对应的process处理

**TCP socket map**
| socket | 源IP      | 源端口 | 目标IP    | 目标端口 | PID    |
| ------ | --------- | ------ | --------- | -------- | ------ |
| 12     | 127.0.0.1 | 80     | 127.0.0.2 | 8090     | 123123 |

> 浏览器在加载站点资源时通过创建多个socket连接来实现并发请求，此时每个socket请求的客户端端口都是不一样的。

TCP的复用和解复用
UDP的socket是二元组的一个数字标识和唯一的一个PID对应
UDP本身是面向无连接的，所以socket仅仅记录了自身IP，port和PID的对应关系
发送方通过同一个port发送数据时会使用同一个socket进行发送
接收方收到数据时解析数据包中的IP和port信息，找到唯一的socket，把报文交给socket对应的process处理
**UDP socket map**
| socket | 源IP      | 源端口 | PID    |
| ------ | --------- | ------ | ------ |
| 12     | 127.0.0.1 | 80     | 123123 |



### 网络应用的体系结构
- 客户-服务器模式（C/S client/service）
  - 服务器
    - 一直运行
    - 固定的IP地址和周知的端口号
    - 扩展性差，数据中心进行扩展
  - 客户端
    - 主动与服务器通信
    - 与互联网有间歇性的连接
    - 可能是动态IP地址
    - 不直接与其他客户端通信
- 对等模式（P2P Peer To Peer）
  - （几乎）没有一直运行的服务器
  - 任意端系统之间可以进行通信
  - 每个节点即是客户端又是服务器
    - 自扩展性-新peer节点带来新的服务能力，当然也带来新的服务请求
  - 参与的主机间歇性连接且可以改变IP地址（难以管理）
  - 例子：Gnutella，迅雷
- 混合体：客户服务器和对等体系结构
  - Napster
    - 文件搜索：集中
      - 主机在中心服务器上注册其资源
      - 主机在中心服务器查询资源位置
    - 文件传输： P2P
      - 任意Peer节点之间
  - 即时通信
    - 在线检测：集中
      - 当用户上线时，向中心服务器注册其IP地址
      - 用户与中心服务器联系，以找到其在线好友的位置
    - 两个用户之间聊天 P2P

### 进程通信
进程：在主机上运行的应用程序
- 在同一个主机内，使用进程间通信机制通信（操作系统定义）
- 不同主机，通过交换报文（Message）来通信
  - 使用OS提供的通信服务
  - 按应用协议交换报文（借助传输层提供的服务）

**clients servers**
- 客户端进程：发起通信的进程
- 服务器进程：等待连接的进程

> P2P架构的应用也有客户端进程和服务器进程之分

### 分布式进程通信需要解决的问题
1. 进程表示和寻址问题（服务用户）
2. 传输层-应用层提供服务时如何（服务）
   1. 位置：层间界面的SAP（TCP/IP socket）
   2. 形式：应用程序接口API（TCP/IP socket api）
3. 如何使用传输层提供的服务，实现应用进程之间的报文交换，实现应用（用户使用服务）
   1. 定义应用层协议：报文格式，解释，时序等
   2. 编制程序，使用OS提供的API，调用网络基础设施提供通信服务传报文，实现应用时序等；

### 对进程进行编址（addressing）
-  进程为了接受报文，必须有一个标识即：SAP（发送也需要标示）
   -  主机：为一个32位IP地址
      -  仅仅有IP地址不能唯一标识一个进程，在一台端系统上有很多应用进程在运行
   - 所采用的传输层协议：TCP or UDP
   - 端口号（Port Numbers）
- 一些知名端口号的例子
  - HTTP TCP 80
  - Mail TCP 25
  - ftp TCP 21
- 一个进程： 用IP+port标示端节点
- 本质上，一对主机进程之间的通信由两个端节点构成

### 传输层提供的服务-层间信息的代码
- 如果socket api每次传输报文，都携带如此多的信息，太繁琐易错，不便于管理
- 用个代号标示通信的双方或者单方：socket
- 就像OS打开文件返回的句柄意义
  - 对句柄的操作，就是对文件的操作
- TCP socket
  - TCP服务，对两个进程之间的通信需要之前要建立连接
    - 两个进程通信会持续一段时间，通信关系稳定
  - 可以用一个证书表示两个应用实体之间的通信关系，本地标识
  - 穿过层间接口的信息量最小
  - TCP socket：源IP，源端口，目标IP，目标端口
- UDP socket
  - UDP服务，两个进程之间的通信需要之前无需建立连接
    - 每个报文都是独立传输的
    - 前后报文可能给不同的分布式进程
  - 因此只能用一个整数表示本应用实体的标示
    - 因为这个报文可能传给另外一个分布式进程
  - 穿过层间接口的信息大小最小
  - UDP socket 2元组（本IP 本端口）
  - 但是传输报文时，必须要提高对方IP，port
    - 接受报文时，传输层需要上传对方的IP，port

### TCP之上的套接字（Socket）
对于使用面向连接服务（TCP）的应用而言，套接字是4元组的一个具有本地意义的标示
- 4元组（源IP，源port，目标IP，目标port）
- 唯一指定了一个会话（两个进程之间的会话关系）
- 应用使用这个标识，与远程的应用程序通信
- 不必在每个报文的发送都要指定这4元组
- 就像使用操作系统打开一个文件，OS返回一个文件句柄一样，以后使用这个文件句柄，而不是使用这个文件的目录名、文件名
- 简单，便于管理

### UDP之上的套接字（Socket）
对于使用无连接服务（UDP）的应用而言，套接字是2元组的一个具有本地意义的标示
  2元组（源IP，源port）
- UDP套接字指定了应用所在的一个端节点（end point）
- 在发送数据报时，采用创建好的本地套接字（标识ID），就不必在发送每个报文中指明白自己所采用的ip和port
- 但是在发送报文时必须要指定对方的ip和UDP port

### 安全TCP
- TCP & UDP
  - 都没有加密
  - 明文通过互联网传输，甚至密码
- SSL
  - 在TCP上面实现，提供加密的TCP连接
  - 私密性
  - 数据完整性
  - 端到端的鉴别
- SSL在应用层
  - 应用采用SSL库，SSL库使用TCP通信
- SSL socket API
  - 应用通过API将明文交给socket，SSL将其加密在互联网上传输



<h1 id="web">2.2 Web and HTTP</h1>
这部分内容比较基础不再做过多的记录

往返时间 RTT（round-trip-time）：一个小的分组从客户端到服务器，再回到客户端的时间（传输时间忽略）

**获取一个文件对象需要两个RTT**
- 一个RTT发起TCP连接
- 一个RTT用来HTTP请求并等待HTTP响应


{% asset_img 20230505-225702.jpeg 网路流量例子 %}

流量强度根据计算公式 = (分组大小*分组速率)/带宽 
LAN的流量强度= (0.1*15)/1000 = 0.15%
接入链路的流量强度= (0.1*15)/1.544 = 0.9715 (强度接近1，其他延时可以忽略不记)
总延时=LAN延时+接入延时+Internet延时 = ms + min + 2s(根据假设)

最后这个网路的总延时是分钟级的，甚至更长

为了解决这个问题解决方案如下
- 增加接入链路的带宽
  根本原因是接入链路流量强度接近1耗时严重，比如把接入链路的带宽从1.54Mbps升级到154Mbps
  接入链路的流量强度= (0.1*15)/154 = 0.0097 
  接入链路耗时 = I/(1-I)*L/R = 0.0097/(1-0.0097)*(1.5/154) = 0.0000954s 很小的时间可以忽略不计
  最后总的耗时接近2s
- 内网增加缓存
  比如现在40%的请求都可以走缓存，60%请求外网
  总的时间计算方式 = 0.4*t1 + 0.6*t2
  t1的时间是ms级可以忽略不计
  t2 = LAN延时+接入延时+Internet延时，现在只有接入延时需要重新计算
  增加缓存之后接入链路的流量强度 = 0.1Mb * 15 * 0.6 / 1.54Mbps = 0.58
  t2接入延时 = I/(1-I)*L/R = 0.58/(1-0.58)*(1.5*0.6/1.54) = 0.8s 实际算出来的时间是秒级的和视频讲的不一致，但是不影响结论
  0.6 * (ms + 0.8s + 2s) = 1.68s 比增加带宽的效果更好
  成本：缓存服务器（比较廉价）


<h1 id="ftp">2.3 FTP*</h1>

### FTP 文件传输协议
- 向远程主机传输文件或从远程主机上接受文件
- 客户/服务器模式
  - 客户端：发起传输的一方
  - 服务器：远程主机
- ftp：RFC959
- ftp服务器端口 21

### 控制链接和数据连接分开

- FTP客户端与FTP服务器通过端口21联系，并使用TCP为传输协议
- 客户端通过控制链接或得身份确认
- 客户端通过控制连接发送命令浏览远程目录
- 收到一个文件传输命令时，服务器打开一个到客户端的数据连接
- 一个文件传输完成后，服务器关闭连接
- 服务器打开第二个TCP数据连接勇来传输另外一个文件
- 控制连接：带外（out of band）传送
- FTP服务器维护用户的状态信息
- FTP服务器维护用户的状态信息：当前路径、用户账户与控制连接对应

{% asset_img 20230506-090955.jpeg FTP命令、响应 %}

<h1 id="email">2.4 Email，SMTP，POP3，IMAP</h1>

### 电子邮件 EMail
- 3个主要组成部分
  - 用户代理
    - 又名“邮件阅读器”
    - 撰写、编辑和阅读邮件
    - 如Outlook、Foxmail
    - 输出和输入邮件保存在服务器上
  - 邮件服务器
    - 邮箱中管理和维护发送给用户的邮件
    - 输出报文队列保持待发送邮件报文
    - 邮件服务器之间的SMTP协议：发送email报文
      - 客户：发送方邮件服务器
      - 服务器：接收端邮件服务器
  - 简单邮件传输协议：SMTP 【RFC 2821】
    - 使用TCP在客户端和服务器之间传送报文，端口号为25
    - 直接传输：从发送方服务器到接收方服务器
    - 传输的3个阶段
      - 握手
      - 传输报文
      - 关闭
    - 命令/响应交互
      - 命令：ASCII文本
      - 响应：状态码和状态信息
    - 报文必须为7位ASCII码

### 例子：Alice给Bob发送报文

1. Alice使用用户代理撰写邮件并发送给Bob
2. Alice的用户代理将邮件发送到她的邮件服务器：邮件放在报文队列中
3. SMTP的客户端打开到Bob邮件服务器的TCP连接
4. SMTP客户端通过TCP连接发送Alice的邮件
5. Bob的邮件服务器将邮件放到Bob的邮箱
6. Bob调用他的用户代理阅读邮件

### 报文格式：多媒体扩展
MIME：多媒体邮件扩展（Multimedia mail extension），RFC 2045，0256
在报文首部用额外的行申明MIME内容类型
{% asset_img 20230506-232702.jpeg MIME内容 %}

### 邮件访问协议
{% asset_img 20230506-232940.jpeg 邮件访问协议 %}

### POP3与IMAP

POP3【本地管理文件夹】
用户确认阶段

- 客户端命令： 
  -  user: 申明用户名 
  -  pass: 口令
- 服务器响应 
  -  +OK 
  -  -ERR
事物处理阶段, 客户端：
- list: 报文号列表
- retr: 根据报文号检索报文
- dele: 删除

- 先前的例子使用 “下载并删除”模式。 
  - 如果改变客户机，Bob不能阅读邮件
- “下载并保留”：不同客户机上为报文的拷贝
- POP3在会话中是无状态的

IMAP 【远程管理文件夹】
- IMAP服务器将每个报文与一个文件夹联系起来
- 允许用户用目录来组织报文
- 允许用户读取报文组件
- IMAP在会话过程中保留用户状态： 
  - 目录名、报文ID与目录名之间映射



<h1 id="dns">2.5 DNS (Domain Name System)</h1>

### DNS的必要性
IP地址标识主机、路由器，但IP地址不好记忆，不便人类使用(没有意义)，人类一般倾向于使用一些有意义的字符串来标识Internet上的设备。例如：qzheng@ustc.edu.cn 所在的邮件服务器，www.ustc.edu.cn 所在的web服务器。
存在着“字符串”—IP地址的转换的必要性，人类用户提供要访问机器的“字符串”名称由DNS负责转换成为二进制的网络地址

### DNS系统需要解决的问题
- 问题1：如何命名设备
  - 用有意义的字符串：好记，便于人类用使用
  - 解决一个平面命名的重名问题：层次化命名
- 问题2：如何完成名字到IP地址的转换
  - 分布式的数据库维护和响应名字查询
- 问题3：如何维护：增加或者删除一个域，需
  - 要在域名系统中做哪些工作

### DNS(Domain Name System)的历史
- ARPANET的名字解析解决方案
  - 主机名：没有层次的一个字符串（一个平面）
  - 存在着一个（集中）维护站：维护着一张 主机名-IP地址的映射文件：Hosts.txt
  - 每台主机定时从维护站取文件
- ARPANET解决方案的问题
  - 当网络中主机数量很大时 
    - 没有层次的主机名称很难分配 
    - 文件的管理、发布、查找都很麻烦

### DNS(Domain Name System)总体思路和目标
- DNS的主要思路
  - 分层的、基于域的命名机制
  - 若干分布式的数据库完成名字到IP地址的转换
  - 运行在UDP之上端口号为53的应用服务
  - 核心的Internet功能，但以应用层协议实现 
    - 在网络边缘处理复杂性
- DNS主要目的：
  - 实现主机名-IP地址的转换(name/IP translate)
  - 其它目的 
    - 主机别名到规范名字的转换：Host aliasing 
    - 邮件服务器别名到邮件服务器的正规名字的转换：Mail server aliasing 
    - 负载均衡：Load Distribution

### 问题1：DNS名字空间(The DNS Name Space)
DNS域名结构
- 一个层面命名设备会有很多重名
- NDS采用层次树状结构的 命名方法
- Internet 根被划为几百个顶级域(top lever domains)
  - 通用的(generic)
    .com; .edu ; .gov ; .int ; .mil ; .net ; .org
    .firm ; .hsop ; .web ; .arts ; .rec ; 
  - 国家的(countries)
    .cn ; .us ; .nl ; .jp
- 每个(子)域下面可划分为若干子域(subdomains)
- 树叶是主机

### 根域名服务器
北美洲10个
欧洲2个
亚洲1个还在日本
{% asset_img 20230507-094244.jpeg 根域名服务器 %}

### DNS命名空间（The DNS Name Space）
{% asset_img 20230507-094916.jpeg 命名树形图 %}

- 域名(Domain Name)
  - 从本域往上，直到树根
  - 中间使用“.”间隔不同的级别
  - 例如：ustc.edu.cn
    auto.ustc.edu.cn
    www.auto. ustc.edu.cn
  - 域的域名：可以用于表示一个域
  - 主机的域名：一个域上的一个主机
- 域名的管理
  - 一个域管理其下的子域
    .jp 被划分为 ac.jp co.jp
    .cn 被划分为 edu.cn com.cn
  - 创建一个新的域，必须征得它所属域的同意
- 域与物理网络无关
  - 域遵从组织界限，而不是物理网络 
    - 一个域的主机可以不在一个网络 
    - 一个网络的主机不一定在一个域
  - 域的划分是逻辑的，而不是物理的
### 问题2：解析问题-名字服务器(Name Server)
- 一个名字服务器的问题
  - 可靠性问题：单点故障
  - 扩展性问题：通信容量
  - 维护问题：远距离的集中式数据库
- 区域(zone)
  - 区域的划分有区域管理者自己决定
  - 将DNS名字空间划分为互不相交的区域，每个区域都是树的一部分
  - 名字服务器： 
    - 每个区域都有一个名字服务器：维护着它所管辖区域的权威信息(authoritative record) 
    - 名字服务器允许被放置在区域之外，以保障可靠性

### TLD服务器
顶级域(TLD)服务器：负责顶级域名（如com, org, net, edu和gov）和所有国家级的顶级域名（如cn, uk, fr, ca, jp ）
- Network solutions 公司维护com TLD服务器 
- Educause公司维护edu TLD服务器


### 区域名字服务器维护资源记录
- 资源记录(resource records)
  - 作用：维护 域名-IP地址(其它)的映射关系
  - 位置：Name Server的分布式数据库中
-  RR格式: (domain_name, ttl, type,class,Value)
  - Domain_name: 域名
  - Ttl: time to live : 生存时间(权威，缓冲记录) - Class 类别 ：对于Internet，值为IN
  - Value 值：可以是数字，域名或ASCII串 
  - Type 类别：资源记录的类型—见下文DNS记录

### DNS记录
DNS ：保存资源记录(RR)的分布式数据库
- Type=NS 
  - Name域名(如foo.com) 
  - Value为该域名的权威服务器的域名
  RR 格式：(name, value, type, ttl)
- Type=A 
  - Name为主机 
  - Value为IP地址
- Type=CNAME 
  - Name为规范名字的别名 www.ibm.com 的规范名字为servereast.backup2.ibm.com 
  - value 为规范名字
- Type=MX 
  - Value为name对应的邮件服务器的名字
TTL：生存时间，决定了资源记录应当从缓存中删除的时间

{% asset_img 20230507-100950.jpeg dns例子 %}

### DNS大致工作过程
- 应用调用 解析器(resolver)
- 解析器作为客户向Name Server发出查询报文（封装在UDP段中）
- Name Server返回响应报文(name/ip)
{% asset_img 20230507-101213.jpeg DNS大致工作过程 %}

#### 本地名字服务器（Local Name Server）
- 并不严格属于层次结构
- 每个ISP (居民区的ISP、公司、大学）都有一个本地DNS服务器
  - 也称为“默认名字服务器”
- 当一个主机发起一个DNS查询时，查询被送到其本地DNS服务器
  - 起着代理的作用，将查询转发到层次结构中

### 名字解析过程
- 目标名字在Local Name Server中 
  - 情况1：查询的名字在该区域内部
  - 情况2：缓存(cashing)
  当与本地名字服务器不能解析名字时，联系根名字服务器顺着根-TLD 一直找到 权威名字服务器
- 目标名字不在Local Name Server中 
  - 递归查询
{% asset_img 20230507-102232.jpeg 递归查询 %}
  
  - 迭代查询
{% asset_img 20230507-102237.jpeg 迭代查询 %}

### DNS协议、报文
DNS协议：查询和响应报文的**报文格式相同**
{% asset_img 20230507-102900.jpeg DNS报文1 %}
{% asset_img 20230507-102906.jpeg DNS报文2 %}

### DNS 提高性能：缓存
-  一旦名字服务器学到了一个映射，就将该映射
缓存起来
-  根服务器通常都在本地服务器中缓存着
  - 使得根服务器不用经常被访问
-  目的：提高效率
-  可能存在的问题：如果情况变化，缓存结果和权威资源记录不一致
-  解决方案：TTL（默认2天）

### 问题3：维护问题：新增一个域
- 在上级域的名字服务器中增加两条记录，指向这个新增
的子域的域名 和域名服务器的地址
- 在新增子域的名字服务器上运行名字服务器，负责本域
的名字解析： 名字->IP地址
  - 需要向该机构提供权威DNS服务器（基本的、和辅助的）的名字和IP地址 -
  - 登记机构在com TLD服务器中插入两条RR记录: (networkutopia.com, dns1.networkutopia.com, NS)
  (dns1.networkutopia.com, 212.212.212.1, A)
- 在networkutopia.com的权威服务器中确保有
  - 用于Web服务器的www.networkuptopia.com的类型为A的记录 
  - 用于邮件服务器mail.networkutopia.com的类型为MX的记录

### 攻击DNS
- DDoS 攻击
  - 对根服务器进行流量轰炸
    攻击：发送大量ping 
    - 没有成功 
    - 原因１：根目录服务器配置了流量过滤器，防火墙 
    - 原因２：Local DNS 服务器
      缓存了TLD服务器的IP地址, 因此无需查询根服务器
  - 向TLD服务器流量轰炸攻击：发送大量查询 
    - 可能更危险 
    - 效果一般，大部分DNS缓存了TLD
- 重定向攻击
  - 中间人攻击 
    - 截获查询，伪造回答，从而攻击某个（DNS回答指定的IP）站点
  - DNS中毒 
    - 发送伪造的应答给DNS服务器，希望它能够缓存这个虚假的结果
  - 技术上较困难：分布式截获和伪造
- 利用DNS基础设施进行DDoS
  - 伪造某个IP进行查询， 攻击这个目标IP
  - 查询放大，响应报文比查询报文大
  - 效果有限
  

<h1 id="p2p">2.6 P2P应用</h1>

### 纯P2P架构
- 没有（或极少）一直运行的
服务器
- 任意端系统都可以直接通信
- 利用peer的服务能力
- Peer节点间歇上网，每次IP地址都有可能变化
例子:
- 文件分发 (BitTorrent)
- 流媒体(KanKan)
- VoIP (Skype)

### P2P文件分发： BitTorrent
- 文件被分为一个个块256KB
- 网络中的这些peers发送接收文件块，相互服务

tracker:跟踪torrent中参与节点
Torrent（洪流）: 节点的组，之间交换文件块

Alice 加入服务器之后 从tracker服务器处获得peer节点列表然后开始和torrent中的peer节点交换块


<h1 id="cdn">2.7 CDN</h1>

### 视频流化服务和CDN：上下文
- 视频流量：占据着互联网大部分的带宽
  - Netflix, YouTube: 占据37%, 16% 的ISP下行流量
  - ~1B YouTube 用户, ~75M Netflix用户
- 挑战：规模性-如何服务者 ~1B 用户?
  - 单个超级服务器无法提供服务（为什么） 
- 挑战：异构性
  - 不同用户拥有不同的能力（例如：有线接入和移动用户；带宽丰富和受限用户） 
- 解决方案: 分布式的，应用层面的基础设施

### 多媒体视频
- 视频：固定速度显示的图像序列、
  - e.g. 24 images/sec
- 网络视频特点： 
  - 高码率：>10x于音频,高的网络带宽需求 
  - 可以被压缩 
  - 90%以上的网络流量是视频
- 数字化图像：像素的阵列 
  - 每个像素被若干bits表示
- 编码：使用图像内和图像间的冗余来降低编码的比特数 
  - 空间冗余(图像内) 
  - 时间冗余(相邻的图像间)

**视频格式分类**
- CBR: (constant bit rate): 以固定速率编码
- VBR: (variable bit rate): 视频编码速率随时间的变化而变化
- 例子: 
  - MPEG 1 (CD-ROM) 1.5 Mbps
  - MPEG2 (DVD) 3-6 Mbps
  - MPEG4 (often used in Internet, < 1 Mbps)

### 多媒体流化服务：DASH
- DASH: Dynamic, Adaptive Streaming over HTTP
- 服务器: 
  - 将视频文件分割成多个块 
  - 每个块独立存储，编码于不同码率（8-10种） 
  - 告示文件（manifest file）: 提供不同块的URL
- 客户端: 
  - 先获取告示文件 
  - 周期性地测量服务器到客户端的带宽 
  - 查询告示文件,在一个时刻请求一个块，HTTP头部指定字节范围
  - 如果带宽足够，选择最大码率的视频块
  - 会话中的不同时刻，可以切换请求不同的编码块 (取决于当时的可用带宽)

### Content Distribution Networks
- 挑战: 服务器如何通过网络向上百万用户同时
流化视频内容 (上百万视频内容)?
- 选择1: 单个的、大的超级服务中心“megaserver”
  - 服务器到客户端路径上跳数较多，瓶颈链路的带宽
小导致停顿
  - “二八规律”决定了网络同时充斥着同一个视频的
多个拷贝，效率低（付费高、带宽浪费、效果差）
  - 单点故障点，性能瓶颈
  - 周边网络的拥塞
评述：相当简单，但是这个方法不可扩展
- 选项2: 通过CDN，全网部署缓存节点，存储服务内容，就近为用户提供服务，提高用户体验
  - enter deep: 将CDN服务器深入到许多接入网
    - 更接近用户，数量多，离用户近，管理困难
    - Akamai, 1700个位置
  - bring home: 部署在少数(10个左右)关键位置，如将服务器簇安装于POP附近（离若干1stISP POP较近）
    - 采用租用线路将服务器簇连接起来
    - Limelight

### CDN:“简单”内容访问场景
Bob(客户端)请求视频http://netcinema.com/6Y7B23V 
视频存储在CDN，位于http://KingCDN.com/NetC6y&B23V

1. Bob访问http://netcinema.com/6Y7B23V 
2. resolve http://netcinema.com/6Y7B23V via Bob’s local DNS
3. netcinema’s DNS returns URL http://KingCDN.com/NetC6y&B23V
4. Resolve http://KingCDN.com/NetC6y&B23 via KingCDN’s authoritative DNS, which returns IP address of KingCDN server with video（CDN 簇选择策略）
5. request video from KingCDN server, streamed via HTTP


{% asset_img 20230507-221744.jpeg 内容访问场景 %}
### 案例学习: Netflix
{% asset_img 20230507-222302.jpeg Netflix %}

<h1 id="tcp">2.8 TCP套接字（Socket）编程</h1>

**2种传输层服务的socket类型:**
- TCP: 可靠的、字节流的服务
- UDP: 不可靠（数据UDP数据报）服务

### TCP套接字编程
{% asset_img 20230507-222649.jpeg TCP套接字编程 %}


<h1 id="udp">2.9 UDP套接字编程</h1>

{% asset_img 20230507-222812.jpeg UDP Socket编程 %}

### TCP和UDP
{% asset_img 20230507-222813.jpeg TCP和UDP沟通过程 %}

<!-- TODO socket 编程实践 https://www.cnblogs.com/cangqinglang/p/9842833.html -->

<h1 id="summary">2.10 小结</h1>

- 应用程序体系结构
  - 客户-服务器
  - P2P
  - 混合
- 应用程序需要的服务品质描述: 
  - 可靠性、带宽、延时、安全
- Internet传输层服务模式
  - 可靠的、面向连接的服务：TCP
  - 不可靠的数据报：UDP
- 流行的应用层协议: 
  - HTTP
  - FTP
  - SMTP, POP, IMAP
  - DNS
- Socket编程

**协议的知识**
- 应用层协议报文类型：请求/响应报文： 
  - 客户端请求信息或服务 
  - 服务器以数据、状态码进行响应
- 报文格式： 
  - 首部：关于数据信息的字段
  - 数据：被交换的信息
- 控制报文 vs. 数据报文
  - 带内、带外
- 集中式 vs. 分散式
- 无状态 vs. 维护状态
- 可靠的 vs. 不可靠的报文传输
- 在网络边缘处理复杂性
  
> 一个协议定义了在两个或多个通信实体之间交换报文的格式和次序、以及就一条报文传输和接收或其他事件采取的动作