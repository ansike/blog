---
title: v8 垃圾回收机制
categories: 编程
tags: js
date: 2022-03-06 22:44:13
---

### 回收策略简述

1. 回收策略主要基于分代式垃圾回收机制, 内存分为新生代和老生代
2. 新生代中的使用 scavenge 算法
3. 老生代使用标记清除(mark-sweep)+标记整理(mark+compact)

### 为什么要分代

对象的生存时间不同,将对象按不同的存活时间分代,然后分别对不同的分代使用更适合的算法可以更高效的垃圾回收.

### scavenge 算法的机制是什么

采用复制的方式实现垃圾回收. scavenge 将新生代内存分为两份,一个处于使用态,一个处于闲置态. 分配对象时先在使用态进行分配. 当开始垃圾回收时检查使用态中存活的对象, 将存活的对象复制到闲置态空间中, 复制完成之后两个存储的角色发生对换, 原空间内存被释放.

### 标记清除(mark-sweep), 标记整理(mark+compact)是什么

标记清除: 标记和清除. 标记阶段遍历堆中的所有对象, 对存活的对象进行标记. 清除阶段, 清除只清除没有被标记的对象.
标记整理: 标记和整理. 标记为死亡对象之后, 将活着的对象往一端移动, 移动完成之后直接清理掉边界外的内存. 当新晋升的对象在老生代无法分配足够的空间时才进行标记整理

### 为什么需要标记整理

标记清除会造成内存不连续问题, 标记整理可以将存活的对象整理到一起, 清理出更大的连续内部.

### 新生代向老生代晋升的条件

1. 已经在新生代被 scavenge 回收过
2. 复制阶段, 如果新生代的目标空间超过 25%, 直接复制到老生代

### 新生代为什么使用 scavenge, 老生代为什么使用标记清除和标记整理

新生代中的对象存活时间较短, scavenge 的复制方式仅需操作较少的存活对象;
老生代中的对象存活时间过长, 标记清除的删除模式仅需要删除较少的死亡对象; 标记整理时对标记清除的一个补充优化

### 什么是全停顿 stop-the-world

为了避免 js 应用逻辑和垃圾回收器看到的不一致, 在进行垃圾回收时, 需要将应用执行暂停, 暂停的行为称为全停顿.

### 怎么优化全停顿

1. 增量标记: 每标记一会儿都让出执行权, 让应用执行一会儿.
2. 延迟清理+增量式整理
