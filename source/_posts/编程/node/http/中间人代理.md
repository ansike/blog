---
title: 反向代理的几种实现
categories: 编程
tags:
  - 基础概念
date: 2020-05-22 17:39:28
---

```javascript
// 最后要请求的真实服务
const http = require('http');
const fs = require('fs');

const server = http.createServer((cReq, cRes)=>{
  // 读取文件文件流返回给Res对象处理
  fs.ReadStream('./server.js').pipe(cRes)
})

server.listen(8001);
console.log('服务启动8001');
```

#### 中间人代理
```javascript
// 客户直接请求的服务
const http = require('http');

const server = http.createServer((cReq, cRes)=>{
  const options = {
    hostname: cReq.hostname,
    // 在这儿改了端口
    port: "8001",
    path: cReq.path,
    method: cReq.method,
    headers: cReq.headers,
  }
  const newReq = http.request(options, (nRes)=>{
    cRes.writeHead(nRes.statusCode, nRes.headers);
    nRes.pipe(cRes);
  }).on("error", (e)=>{
    console.log(e);
    cRes.end("error")
  })
  cReq.pipe(newReq);
})

server.listen(8888);
console.log("服务8888开始启动");

// 客户此时请求时会拿到真实服务中返回的"this data is from 8001"
```

#### 隧道代理
```javascript
var http = require('http');
var net = require('net');

const server = http.createServer((req, res) => {
	console.log('start server');
	connectRequest(res);
});

// create tunnel
function connect(cReq, clientSock) {
	var serverSock = net
		.connect('8001', 'localhost', function() {
			console.log('connect:8001');
			clientSock.write('HTTP/1.1 200 Connection Established\r\n\r\n');
			serverSock.pipe(clientSock);
		})
		.on('error', function(e) {
			clientSock.end();
		});
	clientSock.pipe(serverSock);
}

const connectRequest = (response) => {
	const options = {
		port: 8888,
		host: '127.0.0.1',
		method: 'CONNECT'
	};

	const req = http.request(options);
	req.end();
	req.on('connect', (res, socket, head) => {
		console.log('got connected!');
		let data = '';
		// Make a request over an HTTP tunnel
		socket.write('GET / HTTP/1.1\r\n' + 'Host: \r\n' + 'Connection: close\r\n' + '\r\n');
		socket.on('data', (chunk) => {
			data += chunk;
		});
		socket.on('end', () => {
			response.end(data);
			// server.close();
		});
	});
};

server.on('connect', connect);
server.listen(8888);
```