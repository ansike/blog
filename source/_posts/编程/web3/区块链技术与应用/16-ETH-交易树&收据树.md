---
title: 交易树&收据树
categories: 编程
tags:
  - web3
  - ETH
date: 
---

本系列开始区块链的学习，主要内容为B站上[北京大学肖臻老师《区块链技术与应用》公开课](https://www.bilibili.com/video/BV1Vt411X7JF?p=1&vd_source=22653c02dfbe0c9c7bb4a200eb87fe4e)

交易树：每次发布新区块时，区块中的交易组成交易树。
收据树：每个交易执行完成会形成一个收据，记录该交易的相关信息。

交易树和收据树的用处
1. 提供merkle proof
2. 支持更复杂的查询操作（eg：支持查找过去10天和某个智能合约相关的交易）
  - 解决方案：引入了bloom filter数据结构

bloom filter 原理: 当一个元素被加入到集合时，通过K个散列函数将这个元素映射成一个位数组中的K个点，把它们置为1。检索时，我们只要看看这些点是不是都是1就大约知道集合中有没有它了，如果集合中的值为0说明肯定不存在，如果是1，说明被检测元素可能存在。
bloom filter不支持删除操作（hash collision的原因）。

ETH有关bloom filter的具体例子
每个交易执行完成之后会形成一个收据，收据中包含一个bloom filter，记录交易的类型，地址等其他信息。
发布的区块在块头中有一个总的bloom filter，这个总的bloom filter是该区块中所有交易的bloom filter的并集。
当我们需要查找过去10天发生的某智能合约相关的所有交易方法是：
1. 找哪个区块的块头中的bloom filter 有我们需要的交易的类型，如果块头中没有对应的交易类型，说明这个区块不是我们需要的。
2. 如果块头中有，就去查找这个区块各收据的bloom filter

ETH的运行过程：交易驱动的状态机（tx-driven state machine）。区块中包含tx，状态树中保存账户的状态，通过执行交易，系统从当前状态转移到下一个状态。

UTXO是BTC的state machine


### 某人在ETH发布一个交易，某节点收到这个tx（A->B），有无可能B的地址以前从来没有过？
有可能，因为创建账户不需要广播，只有到收到转账才有可能写到区块中

### 现行状态树的机制是包含全部的账户的状态，可否改成金包含区块中涉及的tx的账户的状态
1. 查找账户的状态不方便，得往前面的区块找，如A=>B的交易，要验证A的全部，如果A很长一段时间内都没有交易，就需要往前找很长。
2. 更严重的问题：还需要找B，如果B是新建的账户，只有找到创世界块（genesis block）才能确定是新的账户。