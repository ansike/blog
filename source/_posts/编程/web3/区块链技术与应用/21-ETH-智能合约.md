---
---
title: 智能合约
categories: 编程
tags:
  - web3
  - ETH
date: 2023-01-12 23:53:46
---

本系列开始区块链的学习，主要内容为B站上[北京大学肖臻老师《区块链技术与应用》公开课](https://www.bilibili.com/video/BV1Vt411X7JF?p=1&vd_source=22653c02dfbe0c9c7bb4a200eb87fe4e)

### 什么是智能合约？
- 智能合约是运行在区块链上的一段代码，代码的逻辑定义了合约的内容
- 智能合约的账户保存了合约当前的运行状态
  - balance 当前余额
  - nonce 交易次数
  - code 合约代码
  - storage 存储，数据结构是一颗MPT
- Solidity是智能合约最常用的语言，语法上和js接近

![代码示例](./20230112-231104.jpeg)

**外部账户如何调用智能合约？**
对于A->B这个交易，如果B是一个账户，则这笔tx是一次普通的转账。而如果B是一个智能合约账户，则这笔tx就是一次A对B合约的调用
创建一个交易，接收地址为要调用的那个智能合约的地址，data域填写钥调用的函数及其参数的编码值。

### 合约中函数调用
![一个合约调用另一个合约中的函数](./20230112-231831.jpeg)

**fallback函数**
- 匿名函数，没有参数也没有返回值
- 在两种情况下会被调用
  - 直接向一个合约地址转账而不加任何data
  - 被调用的函数不存在
- 如果转账金额不是0，同样需要生命payable，否则会抛异常

智能合约的创建与运行
创建合约，外部账户发起一个转账交易到0x0的地址
- 转账金额是0，但是要支付gas
- 合约的代码放在data域里

智能合约运行在EVM（Ethereum Virtual Machine）上
智能合约是个Turing-complete Programming Model
汽油费 gas fee

**为什么需要汽油费？**
为了解决（halting problem）。全节点收到一个对智能合约的调用，计算最多需要的gas fee，并从账户中扣除相应的ETH，待调用完成后得出实际需要的gas fee，返还没有使用的。

EVM中不同指令消耗的gas fee是不一样的
简单的指令（如四则运算）很便宜，复杂的或者需要存储状态的指令（取hash）就很贵。

### 错误处理
ETH的交易具有原子性，即一个交易要么不执行，要么全不执行，不会执行一部分。

**可以抛出错误语句：**
- assert(bool condition) 如果条件不满足就抛出-用于内部错误。
- require(bool condition) 如果条件不满足就抛出-用于输入或者外部的组件引起的错误。
- revert() 终止运行并会滚状态变动-无条件抛错

嵌套调用发生错误是否会连锁式的回滚？
有些会（直接调用），有些不会（call调用）

**一个全节点打包交易到区块中，这些交易有一些是对智能合约的调用，那么全节点是先执行智能合约再挖矿，还是先挖矿再执行智能合约？**
先执行后挖矿
因为挖矿依赖block的hash值，而hash值的计算是需要获取所有交易的信息和状态即3课树的hash，所以肯定是需要先执行交易后挖矿。


**智能合约是否支持多线程处理？**
不支持，状态机必须是完全确定的。多线程如果对内存访问顺序不同，造成的结果可能也会不同。

区块和调用信息
![区块和调用信息](./20230112-234947.jpg)

地址类型
![地址类型](./20230112-234954.jpg)

拍卖案例
<!-- TODO 稍后录入到sol中实现一次 -->
![拍卖1](./20230112-234958.jpeg)
![拍卖2](./20230112-235006.jpeg)